<!DOCTYPE html>
<html lang="en" manifest="cache.manifest">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Klondike Guide">
    <title>Klondike Highway Narrator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(to bottom, #1e3a8a, #1e40af); min-height: 100vh; padding: 16px 16px 200px; }
        .container { max-width: 800px; margin: 0 auto; }
        .header { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 24px; margin-bottom: 16px; }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 28px; color: #1f2937; }
        .header p { color: #6b7280; margin-top: 4px; }
        .header-icon { font-size: 48px; }
        .subtitle { color: #6b7280; font-size: 14px; margin-top: 12px; }
        .gps-section { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 16px; margin-bottom: 16px; }
        .gps-button { width: 100%; background: #10b981; color: white; border: none; border-radius: 8px; padding: 12px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .gps-button:active { background: #059669; }
        .gps-button.active { background: #3b82f6; }
        .gps-button.disabled { background: #9ca3af; cursor: not-allowed; }
        .gps-status { margin-top: 12px; font-size: 14px; color: #6b7280; text-align: center; }
        .location-info { background: #eff6ff; padding: 8px 12px; border-radius: 6px; margin-top: 8px; font-size: 13px; color: #1e40af; }
        .mile-list { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 16px; }
        .mile-scroll { max-height: 500px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .mile-item { padding: 16px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: background-color 0.2s; display: flex; gap: 16px; align-items: flex-start; position: relative; }
        .mile-item:hover { background-color: #eff6ff; }
        .mile-item.active { background-color: #dbeafe; }
        .mile-item.nearest { background-color: #fef3c7; border-left: 4px solid #f59e0b; }
        .mile-item.nearby { background-color: #f0fdf4; }
        .distance-badge { position: absolute; top: 12px; right: 12px; background: #3b82f6; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; }
        .distance-badge.nearest { background: #f59e0b; }
        .distance-badge.nearby { background: #10b981; }
        .mile-icon { font-size: 36px; flex-shrink: 0; margin-top: 4px; }
        .mile-content { flex: 1; min-width: 0; padding-right: 70px; }
        .mile-header { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 4px; }
        .mile-badge { background: #2563eb; color: white; padding: 4px 12px; border-radius: 9999px; font-size: 14px; font-weight: bold; }
        .mile-km { color: #6b7280; font-size: 14px; }
        .mile-title { font-weight: 600; font-size: 18px; color: #1f2937; margin-bottom: 4px; }
        .mile-text { color: #4b5563; font-size: 14px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .mile-play { flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .play-icon { width: 32px; height: 32px; color: #2563eb; }
        .play-indicator { width: 40px; height: 40px; background: #2563eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .pulse { width: 12px; height: 12px; background: white; border-radius: 50%; animation: pulse 1.5s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .footer { text-align: center; color: white; font-size: 14px; opacity: 0.75; margin-top: 16px; }
        .controls { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 2px solid #e5e7eb; box-shadow: 0 -4px 6px rgba(0,0,0,0.1); z-index: 1000; display: none; }
        .controls.active { display: block; }
        .controls-inner { max-width: 800px; margin: 0 auto; padding: 16px; }
        .progress-container { margin-bottom: 16px; }
        .progress-bar { width: 100%; height: 10px; background: #e5e7eb; border-radius: 9999px; overflow: hidden; }
        .progress-fill { height: 100%; background: #2563eb; transition: width 0.1s linear; }
        .progress-text { display: flex; justify-content: space-between; font-size: 12px; color: #6b7280; margin-top: 6px; }
        .progress-status { font-weight: 500; }
        .now-playing { margin-bottom: 12px; }
        .now-playing-label { font-size: 12px; color: #6b7280; margin-bottom: 4px; }
        .now-playing-title { font-weight: 600; color: #1f2937; font-size: 16px; }
        .now-playing-mile { font-size: 14px; color: #4b5563; }
        .playback-controls { display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 12px; }
        .control-btn { background: #f3f4f6; border: none; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s; }
        .control-btn:active { background: #e5e7eb; }
        .control-btn.primary { background: #2563eb; width: 56px; height: 56px; }
        .control-btn.primary:active { background: #1d4ed8; }
        .control-btn.stop { background: #ef4444; }
        .control-btn.stop:active { background: #dc2626; }
        .speed-control { border-top: 1px solid #e5e7eb; padding-top: 12px; }
        .speed-btn, .voice-btn { display: flex; align-items: center; justify-content: center; gap: 8px; background: none; border: none; color: #4b5563; font-size: 14px; cursor: pointer; margin: 0 auto 8px; padding: 8px; }
        .speed-slider, .voice-selector { display: none; margin-top: 12px; padding: 0 16px; }
        .speed-slider.active, .voice-selector.active { display: block; }
        .slider { width: 100%; height: 6px; border-radius: 3px; background: #e5e7eb; outline: none; -webkit-appearance: none; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #2563eb; cursor: pointer; }
        .slider::-moz-range-thumb { width: 20px; height: 20px; border-radius: 50%; background: #2563eb; cursor: pointer; border: none; }
        .speed-labels { display: flex; justify-content: space-between; font-size: 12px; color: #6b7280; margin-top: 4px; }
        .voice-select { width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; background: white; }
        .voice-quality { font-size: 11px; color: #6b7280; margin-top: 4px; }
        svg { width: 24px; height: 24px; }
        .primary svg { width: 32px; height: 32px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div><h1>Klondike Highway</h1><p>Audio Tour Guide</p></div>
                <div class="header-icon">üîä</div>
            </div>
            <p class="subtitle">GPS-enabled narration for your journey</p>
        </div>

        <div class="gps-section">
            <button class="gps-button" id="gpsBtn">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <span id="gpsText">Enable GPS Location</span>
            </button>
            <div class="gps-status" id="gpsStatus"></div>
        </div>

        <div class="mile-list"><div class="mile-scroll" id="mileList"></div></div>

        <div class="footer">
            <p>Murray's Guide to the South Klondike Highway</p>
            <p style="font-size: 12px; margin-top: 4px;">¬© Murray Lundberg</p>
        </div>
    </div>

    <div class="controls" id="controls">
        <div class="controls-inner">
            <div class="progress-container">
                <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                <div class="progress-text">
                    <span id="progressPercent">0%</span>
                    <span class="progress-status" id="progressStatus">Playing</span>
                </div>
            </div>
            <div class="now-playing">
                <div class="now-playing-label">NOW PLAYING</div>
                <div class="now-playing-title" id="nowPlayingTitle"></div>
                <div class="now-playing-mile" id="nowPlayingMile"></div>
            </div>
            <div class="playback-controls">
                <button class="control-btn" id="skipBackBtn" title="Rewind 5 seconds">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0019 16V8a1 1 0 00-1.6-.8l-5.333 4zM4.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0011 16V8a1 1 0 00-1.6-.8l-5.334 4z"/></svg>
                </button>
                <button class="control-btn primary" id="pauseBtn" title="Pause">
                    <svg fill="none" stroke="white" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6"/></svg>
                </button>
                <button class="control-btn" id="skipForwardBtn" title="Skip forward 5 seconds">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.933 12.8a1 1 0 000-1.6L6.6 7.2A1 1 0 005 8v8a1 1 0 001.6.8l5.333-4zM19.933 12.8a1 1 0 000-1.6l-5.333-4A1 1 0 0013 8v8a1 1 0 001.6.8l5.333-4z"/></svg>
                </button>
                <button class="control-btn stop" id="stopBtn" title="Stop">
                    <svg fill="white" viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
                </button>
            </div>
            <div class="speed-control">
                <button class="voice-btn" id="voiceBtn">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
                    <span>Voice: <span id="voiceName">Default</span></span>
                </button>
                <div class="voice-selector" id="voiceSelector">
                    <select class="voice-select" id="voiceSelect"></select>
                    <div class="voice-quality">üí° Tip: Voices with "Enhanced" or "Premium" sound more natural</div>
                </div>
                <button class="speed-btn" id="speedBtn">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    <span>Speed: <span id="speedValue">0.9</span>x</span>
                </button>
                <div class="speed-slider" id="speedSlider">
                    <input type="range" min="0.5" max="2" step="0.1" value="0.9" class="slider" id="speedRange">
                    <div class="speed-labels"><span>0.5x</span><span>1.0x</span><span>2.0x</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
// Mile marker data with GPS coordinates
var mileData=[
{m:"0",k:"0",t:"Skagway Ferry Dock",x:"The Skagway ferry dock. To get through town, you can either go up Broadway through the historic district, or if its busy, turn left at the first stores, go one block and then right at State Street.",i:"üö¢",lat:59.4581,lon:-135.3239},
{m:"0.2",k:"0.4",t:"Centennial Park",x:"Centennial Park, with Rotary snow plow number 1, a sculpture of Chilkoot packers by Chuck Buchanan of Carcross and other attractions.",i:"üóø",lat:59.4593,lon:-135.3229},
{m:"1.6",k:"2.6",t:"Railway Shops",x:"White Pass and Yukon Route railway maintenance shops. Historically, the railway ran 112 miles to Whitehorse.",i:"üöÇ",lat:59.4652,lon:-135.3156},
{m:"1.7",k:"2.7",t:"Pioneer Cemetery",x:"The gravel road to the right takes you to the Pioneer Cemetery, final resting place of Soapy Smith and Frank Reid.",i:"‚õ∞Ô∏è",lat:59.4659,lon:-135.3149},
{m:"2.4",k:"3.9",t:"Dyea Road",x:"The paved road to the left is the Dyea Road, leading first to a very scenic viewpoint over Skagway.",i:"üèîÔ∏è",lat:59.4712,lon:-135.3089},
{m:"2.8",k:"4.5",t:"Highway Gate",x:"This gate is used to close the highway when necessary because of avalanches or rock slides.",i:"üöß",lat:59.4751,lon:-135.3045},
{m:"5.0",k:"8.0",t:"Rocky Point",x:"Large paved pullout with a view of Rocky Point. Mountain goats are occasionally seen on the cliffs.",i:"üêê",lat:59.5123,lon:-135.2567},
{m:"6.8",k:"10.9",t:"US Customs",x:"The U.S. Customs post at Mile 6.8. All southbound vehicles must stop and report.",i:"üõÇ",lat:59.5389,lon:-135.2134},
{m:"7.7",k:"12.4",t:"Pitchfork Falls",x:"Turnout with a great view of Pitchfork Falls. One of the most photographed falls in Alaska.",i:"üíß",lat:59.5512,lon:-135.1923},
{m:"10.0",k:"16.1",t:"Bridal Veil Falls",x:"A particularly nice and accessible waterfall with a large paved parking area.",i:"üåä",lat:59.5834,lon:-135.1456},
{m:"11.0",k:"17.9",t:"Moore Bridge",x:"The William Moore Bridge viewing area. An asymmetrical cable-stayed suspension bridge crossing an earthquake fault.",i:"üåâ",lat:59.5978,lon:-135.1234},
{m:"14.4",k:"23.2",t:"Summit",x:"The summit of the White Pass at 3,292 feet elevation. The highest point on your journey.",i:"üóª",lat:59.6289,lon:-135.0512},
{m:"14.7",k:"23.7",t:"Welcome to Alaska",x:"Welcome to Alaska sign with large parking area. A superb photo stop.",i:"üá∫üá∏",lat:59.6312,lon:-135.0489},
{m:"",k:"36.5",t:"Fraser Customs",x:"The Canada Customs post at Fraser. All vehicles must stop and report.",i:"üá®üá¶",lat:59.7234,lon:-134.8456},
{m:"",k:"47.4",t:"Yukon Bridge",x:"The Tutshi River. The Yukon Suspension Bridge has spectacular views, a cafe and gift shop.",i:"üåâ",lat:59.8123,lon:-134.6789},
{m:"",k:"69.8",t:"Tutshi Panorama",x:"A panoramic view of Tutshi Lake. In any weather, this is a must-stop.",i:"üèîÔ∏è",lat:60.0234,lon:-134.4567},
{m:"",k:"80.3",t:"Welcome to Yukon",x:"Welcome to the Yukon. Watch for Dall sheep and mountain goats on Dail Peak.",i:"üêë",lat:60.1123,lon:-134.3234},
{m:"",k:"105.6",t:"Carcross Town",x:"Turn left to reach downtown Carcross, one of the oldest communities in the Yukon.",i:"üèòÔ∏è",lat:60.1745,lon:-134.7012},
{m:"",k:"107.7",t:"Carcross Desert",x:"The Carcross dunes system, commonly called The Worlds Smallest Desert.",i:"üèúÔ∏è",lat:60.1823,lon:-134.6834},
{m:"",k:"117.6",t:"Emerald Lake",x:"The most-photographed lake in the Yukon.",i:"üíö",lat:60.2456,lon:-134.5678},
{m:"",k:"157.7",t:"Alaska Highway",x:"The Alaska Highway at kilometer 1,404. The city center of Whitehorse is about 22 kilometers to the left.",i:"üõ£Ô∏è",lat:60.7067,lon:-135.0568}
];

var g=null,h='',j=0,p=false,q=false,r=0.9,s=0,t=0,u=null,v=null;
var gpsEnabled=false,watchId=null,currentLat=null,currentLon=null;
var availableVoices=[],selectedVoice=null;

// Load voices
function loadVoices(){
    availableVoices=window.speechSynthesis.getVoices();
    
    // Filter to only English voices (US and GB)
    var englishVoices=availableVoices.filter(function(voice){
        return voice.lang==='en-US'||voice.lang==='en-GB'||
               voice.lang.startsWith('en-US')||voice.lang.startsWith('en-GB');
    });
    
    if(englishVoices.length===0){
        // Fallback to any English voice if en-US/en-GB not found
        englishVoices=availableVoices.filter(function(voice){
            return voice.lang.startsWith('en');
        });
    }
    
    // Only keep quality voices (Enhanced, Premium, or with specific keywords)
    var qualityVoices=englishVoices.filter(function(voice){
        var name=voice.name.toLowerCase();
        return name.includes('enhanced') || name.includes('premium') || 
               name.includes('samantha') || name.includes('alex') || 
               name.includes('karen') || name.includes('daniel') ||
               name.includes('natural') || name.includes('neural') ||
               name.includes('compact');
    });
    
    var select=document.getElementById('voiceSelect');
    select.innerHTML='';
    
    // If no quality voices found, fall back to all English voices
    var voicesToShow=qualityVoices.length>0?qualityVoices:englishVoices;
    
    voicesToShow.forEach(function(voice){
        var opt=document.createElement('option');
        opt.value=availableVoices.indexOf(voice);
        opt.textContent=voice.name+' ('+voice.lang+')';
        opt.dataset.voiceName=voice.name;
        select.appendChild(opt);
    });
    
    // Try to select a good default voice
    var defaultVoice=qualityVoices.find(function(v){
        return v.name.toLowerCase().includes('samantha') || v.name.toLowerCase().includes('enhanced');
    });
    
    if(!defaultVoice&&voicesToShow.length>0){
        defaultVoice=voicesToShow[0];
    }
    
    if(defaultVoice){
        selectedVoice=defaultVoice;
        select.value=availableVoices.indexOf(defaultVoice);
        document.getElementById('voiceName').textContent=defaultVoice.name.split(' ')[0];
    }
}

// Initialize voices
if(speechSynthesis.onvoiceschanged!==undefined){
    speechSynthesis.onvoiceschanged=loadVoices;
}
loadVoices();

// Calculate distance between two coordinates (Haversine formula)
function calculateDistance(lat1,lon1,lat2,lon2){
    var R=6371; // Earth radius in km
    var dLat=(lat2-lat1)*Math.PI/180;
    var dLon=(lon2-lon1)*Math.PI/180;
    var a=Math.sin(dLat/2)*Math.sin(dLat/2)+
           Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
           Math.sin(dLon/2)*Math.sin(dLon/2);
    var c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    return R*c;
}

function updateDistances(){
    if(!currentLat||!currentLon)return;
    
    var nearest=null;
    var nearestDist=999999;
    
    mileData.forEach(function(mile,idx){
        if(!mile.lat||!mile.lon)return;
        var dist=calculateDistance(currentLat,currentLon,mile.lat,mile.lon);
        mile.distance=dist;
        
        if(dist<nearestDist){
            nearestDist=dist;
            nearest=idx;
        }
    });
    
    renderMileList();
    
    // Scroll to nearest
    if(nearest!==null){
        var nearestEl=document.querySelector('[data-index="'+nearest+'"]');
        if(nearestEl){
            nearestEl.scrollIntoView({behavior:'smooth',block:'center'});
        }
    }
}

function toggleGPS(){
    if(!navigator.geolocation){
        document.getElementById('gpsStatus').textContent='GPS not supported on this device';
        return;
    }
    
    if(gpsEnabled){
        // Disable GPS
        if(watchId!==null){
            navigator.geolocation.clearWatch(watchId);
            watchId=null;
        }
        gpsEnabled=false;
        currentLat=null;
        currentLon=null;
        document.getElementById('gpsBtn').classList.remove('active');
        document.getElementById('gpsText').textContent='Enable GPS Location';
        document.getElementById('gpsStatus').innerHTML='';
        renderMileList();
    }else{
        // Enable GPS
        document.getElementById('gpsBtn').classList.add('disabled');
        document.getElementById('gpsText').textContent='Getting location...';
        document.getElementById('gpsStatus').textContent='Requesting GPS permission...';
        
        watchId=navigator.geolocation.watchPosition(
            function(position){
                currentLat=position.coords.latitude;
                currentLon=position.coords.longitude;
                gpsEnabled=true;
                document.getElementById('gpsBtn').classList.remove('disabled');
                document.getElementById('gpsBtn').classList.add('active');
                document.getElementById('gpsText').textContent='GPS Tracking Active';
                document.getElementById('gpsStatus').innerHTML='<div class="location-info">üìç Lat: '+currentLat.toFixed(4)+', Lon: '+currentLon.toFixed(4)+'</div>';
                updateDistances();
            },
            function(error){
                document.getElementById('gpsBtn').classList.remove('disabled');
                document.getElementById('gpsStatus').textContent='GPS error: '+error.message;
            },
            {enableHighAccuracy:true,maximumAge:10000,timeout:5000}
        );
    }
}

function renderMileList(){
    var list=document.getElementById('mileList');
    list.innerHTML=mileData.map(function(item,idx){
        var distBadge='';
        var classes='mile-item';
        
        if(item.distance!==undefined){
            var distKm=item.distance;
            var distMi=distKm*0.621371;
            var distText=distKm<1?Math.round(distKm*1000)+'m':distKm.toFixed(1)+'km';
            
            if(distKm<0.5){
                classes+=' nearest';
                distBadge='<div class="distance-badge nearest">üìç '+distText+'</div>';
            }else if(distKm<5){
                classes+=' nearby';
                distBadge='<div class="distance-badge nearby">'+distText+'</div>';
            }else if(distKm<20){
                distBadge='<div class="distance-badge">'+distText+'</div>';
            }
        }
        
        return'<div class="'+classes+'" data-index="'+idx+'">'+distBadge+'<div class="mile-icon">'+item.i+'</div><div class="mile-content"><div class="mile-header"><span class="mile-badge">'+(item.m?'Mile '+item.m:'Km '+item.k)+'</span><span class="mile-km">'+(item.m?'('+item.k+' km)':'')+'</span></div><div class="mile-title">'+item.t+'</div><div class="mile-text">'+item.x+'</div></div><div class="mile-play"><svg class="play-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div></div>'
    }).join('');
}

function setupEventListeners(){
    document.getElementById('gpsBtn').addEventListener('click',toggleGPS);
    
    document.querySelectorAll('.mile-item').forEach(function(item){
        item.addEventListener('click',function(){
            var idx=parseInt(this.dataset.index);
            var mile=mileData[idx];
            z(mile.x,idx,mile.t,mile.m||'Km '+mile.k);
        });
    });
    
    document.getElementById('pauseBtn').addEventListener('click',A);
    document.getElementById('stopBtn').addEventListener('click',B);
    document.getElementById('skipBackBtn').addEventListener('click',C);
    document.getElementById('skipForwardBtn').addEventListener('click',D);
    
    document.getElementById('voiceBtn').addEventListener('click',function(){
        document.getElementById('voiceSelector').classList.toggle('active');
    });
    
    document.getElementById('voiceSelect').addEventListener('change',function(){
        var idx=parseInt(this.value);
        selectedVoice=availableVoices[idx];
        var shortName=selectedVoice.name.split(' ')[0];
        document.getElementById('voiceName').textContent=shortName;
        if(p&&!q){
            E(h,j,true);
        }
    });
    
    document.getElementById('speedBtn').addEventListener('click',function(){
        document.getElementById('speedSlider').classList.toggle('active');
    });
    
    document.getElementById('speedRange').addEventListener('input',function(){
        r=parseFloat(this.value);
        document.getElementById('speedValue').textContent=r.toFixed(1);
        if(p&&!q){
            E(h,j,true);
        }
    });
}

function z(a,b,c,d){
    if(g===b&&(p||q)){
        A();
        return;
    }
    h=a;
    g=b;
    j=0;
    t=0;
    document.getElementById('nowPlayingTitle').textContent=c;
    document.getElementById('nowPlayingMile').textContent=d;
    F();
    E(a,0,false);
}

function E(a,b,c){
    window.speechSynthesis.cancel();
    if(u)clearInterval(u);
    
    var textToSpeak=a.substring(b);
    var totalLength=a.length;
    
    if(textToSpeak.trim().length===0){
        B();
        return;
    }
    
    var estimatedDurationMs=(textToSpeak.length/5/150)*60000/r;
    v=new SpeechSynthesisUtterance(textToSpeak);
    v.rate=r;
    v.pitch=1;
    v.volume=1;
    
    if(selectedVoice){
        v.voice=selectedVoice;
    }
    
    var initialProgress=c?t:(b/totalLength)*100;
    s=initialProgress;
    G();
    
    var startTime=Date.now();
    u=setInterval(function(){
        var elapsed=Date.now()-startTime;
        var progressPercent=initialProgress+(elapsed/estimatedDurationMs*(100-initialProgress));
        if(progressPercent>=100){
            s=100;
            G();
            if(u)clearInterval(u);
        }else{
            s=Math.min(progressPercent,99);
            G();
        }
    },50);
    
    v.onstart=function(){
        p=true;
        q=false;
        document.getElementById('controls').classList.add('active');
        H();
    };
    
    v.onend=function(){
        p=false;
        q=false;
        g=null;
        j=0;
        s=100;
        G();
        setTimeout(function(){
            s=0;
            t=0;
            G();
            document.getElementById('controls').classList.remove('active');
            F();
        },500);
        if(u)clearInterval(u);
    };
    
    v.onerror=function(){
        if(u)clearInterval(u);
    };
    
    v.onboundary=function(event){
        if(event.name==='word'&&event.charIndex!==undefined){
            j=b+event.charIndex;
        }
    };
    
    window.speechSynthesis.speak(v);
}

function A(){
    if(!h||g===null)return;
    if(q){
        E(h,j,true);
    }else{
        t=s;
        window.speechSynthesis.cancel();
        if(u)clearInterval(u);
        q=true;
        p=false;
        H();
    }
}

function B(){
    window.speechSynthesis.cancel();
    if(u)clearInterval(u);
    p=false;
    q=false;
    g=null;
    j=0;
    s=0;
    t=0;
    G();
    document.getElementById('controls').classList.remove('active');
    F();
}

function C(){
    if(!h)return;
    var newPosition=Math.max(0,j-50);
    j=newPosition;
    t=Math.max(0,s-10);
    E(h,newPosition,true);
}

function D(){
    if(!h)return;
    var newPosition=Math.min(h.length-1,j+50);
    j=newPosition;
    t=Math.min(100,s+10);
    E(h,newPosition,true);
}

function G(){
    document.getElementById('progressFill').style.width=s+'%';
    document.getElementById('progressPercent').textContent=Math.round(s)+'%';
    document.getElementById('progressStatus').textContent=q?'‚è∏ Paused':'‚ñ∂ Playing';
}

function H(){
    var pauseBtn=document.getElementById('pauseBtn');
    if(q){
        pauseBtn.innerHTML='<svg fill="none" stroke="white" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
        pauseBtn.title="Resume";
    }else{
        pauseBtn.innerHTML='<svg fill="none" stroke="white" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6"/></svg>';
        pauseBtn.title="Pause";
    }
}

function F(){
    document.querySelectorAll('.mile-item').forEach(function(item,idx){
        if(idx===g&&(p||q)){
            item.classList.add('active');
            var playContainer=item.querySelector('.mile-play');
            if(q){
                playContainer.innerHTML='<div class="play-indicator"><svg fill="none" stroke="white" viewBox="0 0 24 24" style="width: 20px; height: 20px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6"/></svg></div>';
            }else{
                playContainer.innerHTML='<div class="play-indicator"><div class="pulse"></div></div>';
            }
        }else{
            item.classList.remove('active');
            var playContainer=item.querySelector('.mile-play');
            playContainer.innerHTML='<svg class="play-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
        }
    });
}

renderMileList();
setupEventListeners();

var lastTouchEnd=0;
document.addEventListener('touchend',function(event){
    var now=Date.now();
    if(now-lastTouchEnd<=300){
        event.preventDefault();
    }
    lastTouchEnd=now;
},false);
    </script>
</body>
</html>